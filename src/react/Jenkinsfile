// https://plugins.jenkins.io/build-timestamp/#:~:text=Export%20build%20timestamps%20to%20build%20env

pipeline {
    agent any
    environment {
        _REPOSITORY = "liverpool-portal-uniformes-dev-images-apps"
        _IMAGE = "frontend-uniformes-service"
        _LOCATION = "us-east4"
        _PROJECT = "labuniformes"
        _IMAGE_PATH = "${_LOCATION}-docker.pkg.dev/${_PROJECT}/${_REPOSITORY}/${_IMAGE}"
        _BUCKET = 'jenkinsbucketlab' 
        _LOGNAME = "log_uniformesfrontend_${BUILD_TIMESTAMP}.txt" //configurar en system
    }
    stages {
        stage ('Build') {
            steps {
                echo("---- Build image----")
                // dir('src/react') {
                //     withCredentials([file(credentialsId: 'key-sa', variable: 'GC_KEY')]) {
                //         sh("gcloud auth activate-service-account --key-file=${GC_KEY}")
                //         sh("gcloud auth configure-docker ${_LOCATION}-docker.pkg.dev")
                //         sh("docker build -t ${_IMAGE_PATH} .")
                //         sh("docker push ${_IMAGE_PATH}")
                //     }
                // }
            }
        }
        // stage ('Deploy') {
        //     steps {
        //         echo("---- Deploy to Cloud Run ----")
        //         dir('src/react/cloudrun/qa') {
        //             withCredentials([file(credentialsId: 'key-sa', variable: 'GC_KEY')]) {
        //                 sh("gcloud config set run/region ${_LOCATION}")
        //                 sh("gcloud run services replace cloud-run-service.yaml --project ${_PROJECT} --region ${_LOCATION}")
        //             }
        //         }
        //     }
        // }
    }
    post {
        always {
            echo("---- UPLOAD LOG ----")
            step([$class: 'StdoutUploadStep', credentialsId: "key-sa",  bucket: "gs://${env._BUCKET}/logs", logName: env._LOGNAME])
        }
        // always {
        //     echo("---- UPLOAD LOG ----")
        //     withCredentials([file(credentialsId: 'key-sa', variable: 'GC_KEY')]) {
        //         sh("curl  ${BUILD_URL}/consoleText -o ${_LOGNAME}")
        //         sh("gsutil cp ${_LOGNAME} gs://${_BUCKET}/logs/ ")
        //     }
            // echo("---- Delete image ----")
            // sh("docker rmi ${_IMAGE_PATH}")
        // }
    }
}
